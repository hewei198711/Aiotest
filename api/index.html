<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Api - Aiotest</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Api";
        var mkdocs_page_input_path = "api.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Aiotest
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../what-is-aiotest/">What is Aiotest</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Your first test</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../writing-a-aiotestfile/">Writing a aiotestfile</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../command-line-options/">Command Line Options</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-distributed/">Distributed load test</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../seckill-semaphore-wait/">Seckill semaphore wait</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-in-command-line/">Running In Command Line</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-in-docker/">Running in Docker</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../custom-load-shape/">Custom load shapes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../events-hooks/">Event hooks</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../prometheus-grafana/">Data Presentation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../testing-other-systems/">Testing Other Systems</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Api</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#user-class">User class</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.user.User">aiotest.user.User</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.user.User.on_start">on_start()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.user.User.on_stop">on_stop()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.user.User.start">start()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#asynchttpuser-class">AsyncHttpUser class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.user.AsyncHttpUser">aiotest.user.AsyncHttpUser</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#clienttimeout-class">ClientTimeout class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientTimeout">aiotest.client.ClientTimeout</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#clientsession-class">ClientSession class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession">aiotest.client.ClientSession</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.closed">closed</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.connector">connector</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.cookie_jar">cookie_jar</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.headers">headers</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.timeout">timeout</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.close">close()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.delete">delete()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.detach">detach()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.get">get()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.head">head()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.options">options()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.patch">patch()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.post">post()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.put">put()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.client.ClientSession.request">request()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#loadusershape-class">LoadUserShape class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.shape.LoadUserShape">aiotest.shape.LoadUserShape</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.shape.LoadUserShape.get_run_time">get_run_time()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.shape.LoadUserShape.reset_time">reset_time()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.shape.LoadUserShape.tick">tick()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#runner-class">Runner class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner">aiotest.runners.Runner</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.user_count">user_count</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.quit">quit()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.shape_run">shape_run()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.start">start()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.start_shape">start_shape()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.start_users">start_users()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.stop">stop()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.stop_users">stop_users()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.Runner.weight_users">weight_users()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#localrunner-class">LocalRunner class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.LocalRunner">aiotest.runners.LocalRunner</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.LocalRunner.start">start()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.LocalRunner.stop">stop()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#masterrunner-class">MasterRunner class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.MasterRunner">aiotest.runners.MasterRunner</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.MasterRunner.user_count">user_count</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.MasterRunner.quit">quit()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.MasterRunner.start">start()</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.MasterRunner.stop">stop()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#workerrunner-class">WorkerRunner class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.WorkerRunner">aiotest.runners.WorkerRunner</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.runners.WorkerRunner.quit">quit()</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#setup_logging">setup_logging</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.log.setup_logging">aiotest.log.setup_logging</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#events-class">Events class</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#aiotest.events.EventHook">aiotest.events.EventHook</a>
    </li>
    </ul>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Aiotest</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">Api</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="api-reference">API Reference</h1>
<h3 id="user-class"><span id="User">User class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.user.User"></a>
    <div class="doc doc-contents first">


        <details class="quote">
          <summary>Source code in <code>aiotest\user.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">UserMeta</span><span class="p">):</span>
    <span class="n">host</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a User starts running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a User stops running (is canceled)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">start_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_stop</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Synchronization executes coroutines job from top to bottom</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_start</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_stop</span><span class="p">()</span>
                <span class="k">raise</span>                
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">job</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_stop</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">user_error</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="n">runners</span><span class="o">.</span><span class="n">global_runner</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">















  <div class="doc doc-object doc-method">



<h2 id="aiotest.user.User.on_start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Called when a User starts running.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\user.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">on_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when a User starts running.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.user.User.on_stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">on_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Called when a User stops running (is canceled)</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\user.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">on_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when a User stops running (is canceled)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.user.User.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Synchronization executes coroutines job from top to bottom</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\user.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Synchronization executes coroutines job from top to bottom</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_start</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_stop</span><span class="p">()</span>
            <span class="k">raise</span>                
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">job</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wait_time</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_stop</span><span class="p">()</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">user_error</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="n">runners</span><span class="o">.</span><span class="n">global_runner</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>

<h3 id="asynchttpuser-class"><br /><span id="AsyncHttpUser">AsyncHttpUser class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.user.AsyncHttpUser"></a>
    <div class="doc doc-contents first">

      <p>Represents an AsyncHttp "user" which is to be started and attack the system that is to be load tested.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\user.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AsyncHttpUser</span><span class="p">(</span><span class="n">User</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an AsyncHttp &quot;user&quot; which is to be started and attack the system that is to be load tested.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">ClientSession</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>

<h3 id="clienttimeout-class"><br />ClientTimeout class</h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.client.ClientTimeout"></a>
    <div class="doc doc-contents first">


        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ClientTimeout</span><span class="p">:</span>
    <span class="n">total</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">connect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sock_read</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sock_connect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># pool_queue_timeout: Optional[float] = None</span>
    <span class="c1"># dns_resolution_timeout: Optional[float] = None</span>
    <span class="c1"># socket_connect_timeout: Optional[float] = None</span>
    <span class="c1"># connection_acquiring_timeout: Optional[float] = None</span>
    <span class="c1"># new_connection_timeout: Optional[float] = None</span>
    <span class="c1"># http_header_timeout: Optional[float] = None</span>
    <span class="c1"># response_body_timeout: Optional[float] = None</span>

    <span class="c1"># to create a timeout specific for a single request, either</span>
    <span class="c1"># - create a completely new one to overwrite the default</span>
    <span class="c1"># - or use http://www.attrs.org/en/stable/api.html#attr.evolve</span>
    <span class="c1"># to overwrite the defaults</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">












  </div>

    </div>

  </div>

<h3 id="clientsession-class"><br /><span id="ClientSession">ClientSession class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.client.ClientSession"></a>
    <div class="doc doc-contents first">

      <p>First-class interface for making HTTP requests.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ClientSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;First-class interface for making HTTP requests.&quot;&quot;&quot;</span>

    <span class="n">ATTRS</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="s2">&quot;_base_url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_source_traceback&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_connector&quot;</span><span class="p">,</span>
            <span class="s2">&quot;requote_redirect_url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_loop&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_cookie_jar&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_connector_owner&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_default_auth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_version&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_json_serialize&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_requote_redirect_url&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_timeout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_raise_for_status&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_auto_decompress&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_trust_env&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_default_headers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_skip_auto_headers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_request_class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_response_class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_ws_response_class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_trace_configs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_read_bufsize&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">_source_traceback</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[traceback.StackSummary]</span>
    <span class="n">_connector</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># type: Optional[BaseConnector]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StrOrURL</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">connector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseConnector</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseCookies</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_auto_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">json_serialize</span><span class="p">:</span> <span class="n">JSONEncoder</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span>
        <span class="n">request_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ClientRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClientRequest</span><span class="p">,</span>
        <span class="n">response_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ClientResponse</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClientResponse</span><span class="p">,</span>
        <span class="n">ws_response_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">ClientWebSocketResponse</span><span class="p">]</span> <span class="o">=</span> <span class="n">ClientWebSocketResponse</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">HttpVersion</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpVersion11</span><span class="p">,</span>
        <span class="n">cookie_jar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AbstractCookieJar</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">connector_owner</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">raise_for_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">read_timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentinel</span><span class="p">,</span>
        <span class="n">conn_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">ClientTimeout</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentinel</span><span class="p">,</span>
        <span class="n">auto_decompress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trust_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">requote_redirect_url</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">trace_configs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">TraceConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">read_bufsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">connector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="n">connector</span><span class="o">.</span><span class="n">_loop</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">get_running_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">base_url</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">URL</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">URL</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="o">.</span><span class="n">origin</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span>
            <span class="p">),</span> <span class="s2">&quot;Only absolute URLs without path part are supported&quot;</span>

        <span class="k">if</span> <span class="n">connector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">connector</span> <span class="o">=</span> <span class="n">TCPConnector</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">connector</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Session and connector has to use same event loop&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">loop</span>

        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">get_debug</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_source_traceback</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_stack</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">cookie_jar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cookie_jar</span> <span class="o">=</span> <span class="n">CookieJar</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookie_jar</span> <span class="o">=</span> <span class="n">cookie_jar</span>

        <span class="k">if</span> <span class="n">cookies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cookie_jar</span><span class="o">.</span><span class="n">update_cookies</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="o">=</span> <span class="n">connector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connector_owner</span> <span class="o">=</span> <span class="n">connector_owner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_auth</span> <span class="o">=</span> <span class="n">auth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_serialize</span> <span class="o">=</span> <span class="n">json_serialize</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">DEFAULT_TIMEOUT</span>
            <span class="k">if</span> <span class="n">read_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;read_timeout is deprecated, &quot;</span> <span class="s2">&quot;use timeout argument instead&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="n">read_timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conn_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">evolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="n">conn_timeout</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;conn_timeout is deprecated, &quot;</span> <span class="s2">&quot;use timeout argument instead&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="k">if</span> <span class="n">read_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;read_timeout and timeout parameters &quot;</span>
                    <span class="s2">&quot;conflict, please setup &quot;</span>
                    <span class="s2">&quot;timeout.read&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">conn_timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;conn_timeout and timeout parameters &quot;</span>
                    <span class="s2">&quot;conflict, please setup &quot;</span>
                    <span class="s2">&quot;timeout.connect&quot;</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raise_for_status</span> <span class="o">=</span> <span class="n">raise_for_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_auto_decompress</span> <span class="o">=</span> <span class="n">auto_decompress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trust_env</span> <span class="o">=</span> <span class="n">trust_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requote_redirect_url</span> <span class="o">=</span> <span class="n">requote_redirect_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_bufsize</span> <span class="o">=</span> <span class="n">read_bufsize</span>

        <span class="c1"># Convert to list of tuples</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">real_headers</span><span class="p">:</span> <span class="n">CIMultiDict</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIMultiDict</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_headers</span> <span class="o">=</span> <span class="n">CIMultiDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span><span class="p">:</span> <span class="n">CIMultiDict</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_headers</span>
        <span class="k">if</span> <span class="n">skip_auto_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skip_auto_headers</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">istr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skip_auto_headers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_skip_auto_headers</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_request_class</span> <span class="o">=</span> <span class="n">request_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_class</span> <span class="o">=</span> <span class="n">response_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ws_response_class</span> <span class="o">=</span> <span class="n">ws_response_class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_trace_configs</span> <span class="o">=</span> <span class="n">trace_configs</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">trace_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_configs</span><span class="p">:</span>
            <span class="n">trace_config</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="s2">&quot;ClientSession&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Inheritance class </span><span class="si">{}</span><span class="s2"> from ClientSession &quot;</span>
            <span class="s2">&quot;is discouraged&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>

        <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ATTRS</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Setting custom ClientSession.</span><span class="si">{}</span><span class="s2"> attribute &quot;</span>
                    <span class="s2">&quot;is discouraged&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                    <span class="ne">DeprecationWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_warnings</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">warnings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">PY_36</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">_warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unclosed client session </span><span class="si">{</span><span class="bp">self</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;client_session&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Unclosed client session&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_traceback</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;source_traceback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_traceback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_exception_handler</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_build_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_or_url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">URL</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">str_or_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">()</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_url</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">str_or_url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">json</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseCookies</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_auto_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">chunked</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">expect100</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">raise_for_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">read_until_eof</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StrOrURL</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ClientTimeout</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="n">sentinel</span><span class="p">,</span>
        <span class="n">verify_ssl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fingerprint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">Fingerprint</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trace_request_ctx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SimpleNamespace</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">read_bufsize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientResponse</span><span class="p">:</span>

        <span class="c1"># NOTE: timeout clamps existing connect and read timeouts.  We cannot</span>
        <span class="c1"># set the default to None because we need to detect if the user wants</span>
        <span class="c1"># to use the existing timeouts by setting timeout to None.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Session is closed&quot;</span><span class="p">)</span>

        <span class="n">ssl</span> <span class="o">=</span> <span class="n">_merge_ssl_params</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;data and json parameters can not be used at the same time&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">JsonPayload</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">dumps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_serialize</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunked</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">chunked</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Chunk size is deprecated #1615&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="n">redirects</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

        <span class="c1"># Merge with default headers and transform to CIMultiDict</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">proxy_headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_headers</span><span class="p">(</span><span class="n">proxy_headers</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_url</span><span class="p">(</span><span class="n">str_or_url</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidURL</span><span class="p">(</span><span class="n">str_or_url</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="n">skip_headers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_skip_auto_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">skip_auto_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">skip_auto_headers</span><span class="p">:</span>
                <span class="n">skip_headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">istr</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InvalidURL</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="n">sentinel</span><span class="p">:</span>
            <span class="n">real_timeout</span><span class="p">:</span> <span class="n">ClientTimeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">ClientTimeout</span><span class="p">):</span>
                <span class="n">real_timeout</span> <span class="o">=</span> <span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">real_timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="c1"># timeout is cumulative for all request operations</span>
        <span class="c1"># (request, redirects, responses, data consuming)</span>
        <span class="n">tm</span> <span class="o">=</span> <span class="n">TimeoutHandle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">,</span> <span class="n">real_timeout</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">read_bufsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_bufsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_bufsize</span>

        <span class="n">traces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Trace</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">trace_config</span><span class="p">,</span>
                <span class="n">trace_config</span><span class="o">.</span><span class="n">trace_config_ctx</span><span class="p">(</span><span class="n">trace_request_ctx</span><span class="o">=</span><span class="n">trace_request_ctx</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">trace_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_configs</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">trace</span><span class="o">.</span><span class="n">send_request_start</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">update_query</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="p">)</span>

        <span class="n">timer</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">timer</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timer</span><span class="p">:</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">url</span><span class="p">,</span> <span class="n">auth_from_url</span> <span class="o">=</span> <span class="n">strip_auth_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">auth</span> <span class="ow">and</span> <span class="n">auth_from_url</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot combine AUTH argument with &quot;</span>
                            <span class="s2">&quot;credentials encoded in URL&quot;</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">auth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">auth</span> <span class="o">=</span> <span class="n">auth_from_url</span>
                    <span class="k">if</span> <span class="n">auth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_auth</span>
                    <span class="c1"># It would be confusing if we support explicit</span>
                    <span class="c1"># Authorization header with auth argument</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">auth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">AUTHORIZATION</span> <span class="ow">in</span> <span class="n">headers</span>
                    <span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;Cannot combine AUTHORIZATION header &quot;</span>
                            <span class="s2">&quot;with AUTH argument or credentials &quot;</span>
                            <span class="s2">&quot;encoded in URL&quot;</span>
                        <span class="p">)</span>

                    <span class="n">all_cookies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookie_jar</span><span class="o">.</span><span class="n">filter_cookies</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cookies</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tmp_cookie_jar</span> <span class="o">=</span> <span class="n">CookieJar</span><span class="p">()</span>
                        <span class="n">tmp_cookie_jar</span><span class="o">.</span><span class="n">update_cookies</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
                        <span class="n">req_cookies</span> <span class="o">=</span> <span class="n">tmp_cookie_jar</span><span class="o">.</span><span class="n">filter_cookies</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">req_cookies</span><span class="p">:</span>
                            <span class="n">all_cookies</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">req_cookies</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">proxy</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trust_env</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">LookupError</span><span class="p">):</span>
                            <span class="n">proxy</span><span class="p">,</span> <span class="n">proxy_auth</span> <span class="o">=</span> <span class="n">get_env_proxy_for_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

                    <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_class</span><span class="p">(</span>
                        <span class="n">method</span><span class="p">,</span>
                        <span class="n">url</span><span class="p">,</span>
                        <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                        <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                        <span class="n">skip_auto_headers</span><span class="o">=</span><span class="n">skip_headers</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">cookies</span><span class="o">=</span><span class="n">all_cookies</span><span class="p">,</span>
                        <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                        <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
                        <span class="n">chunked</span><span class="o">=</span><span class="n">chunked</span><span class="p">,</span>
                        <span class="n">expect100</span><span class="o">=</span><span class="n">expect100</span><span class="p">,</span>
                        <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">,</span>
                        <span class="n">response_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_class</span><span class="p">,</span>
                        <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
                        <span class="n">proxy_auth</span><span class="o">=</span><span class="n">proxy_auth</span><span class="p">,</span>
                        <span class="n">timer</span><span class="o">=</span><span class="n">timer</span><span class="p">,</span>
                        <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">ssl</span><span class="o">=</span><span class="n">ssl</span><span class="p">,</span>
                        <span class="n">proxy_headers</span><span class="o">=</span><span class="n">proxy_headers</span><span class="p">,</span>
                        <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># Collect request data</span>
                    <span class="n">request_meta</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">request_meta</span><span class="p">[</span><span class="s2">&quot;request_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="n">url</span><span class="o">.</span><span class="n">path</span>
                    <span class="n">request_meta</span><span class="p">[</span><span class="s2">&quot;request_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">method</span>

                    <span class="c1"># connection timeout</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">async</span> <span class="k">with</span> <span class="n">ceil_timeout</span><span class="p">(</span><span class="n">real_timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">):</span>
                            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                            <span class="c1"># requests start time</span>
                            <span class="n">request_meta</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_timer</span><span class="p">()</span>
                            <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                                <span class="n">req</span><span class="p">,</span> <span class="n">traces</span><span class="o">=</span><span class="n">traces</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">real_timeout</span>
                            <span class="p">)</span>
                    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">ServerTimeoutError</span><span class="p">(</span>
                            <span class="s2">&quot;Connection timeout &quot;</span> <span class="s2">&quot;to host </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

                    <span class="k">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                    <span class="k">assert</span> <span class="n">conn</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">set_response_params</span><span class="p">(</span>
                        <span class="n">timer</span><span class="o">=</span><span class="n">timer</span><span class="p">,</span>
                        <span class="n">skip_payload</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">,</span>
                        <span class="n">read_until_eof</span><span class="o">=</span><span class="n">read_until_eof</span><span class="p">,</span>
                        <span class="n">auto_decompress</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_auto_decompress</span><span class="p">,</span>
                        <span class="n">read_timeout</span><span class="o">=</span><span class="n">real_timeout</span><span class="o">.</span><span class="n">sock_read</span><span class="p">,</span>
                        <span class="n">read_bufsize</span><span class="o">=</span><span class="n">read_bufsize</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="n">req</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                                <span class="n">resp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                <span class="k">raise</span>
                        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">raise</span>
                    <span class="k">except</span> <span class="n">ClientError</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">):</span>
                            <span class="k">raise</span>
                        <span class="k">raise</span> <span class="n">ClientOSError</span><span class="p">(</span><span class="o">*</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_cookie_jar</span><span class="o">.</span><span class="n">update_cookies</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

                    <span class="c1"># redirects</span>
                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">307</span><span class="p">,</span> <span class="mi">308</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allow_redirects</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">trace</span><span class="o">.</span><span class="n">send_request_redirect</span><span class="p">(</span>
                                <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">update_query</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">resp</span>
                            <span class="p">)</span>

                        <span class="n">redirects</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">max_redirects</span> <span class="ow">and</span> <span class="n">redirects</span> <span class="o">&gt;=</span> <span class="n">max_redirects</span><span class="p">:</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">raise</span> <span class="n">TooManyRedirects</span><span class="p">(</span>
                                <span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">request_info</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="c1"># For 301 and 302, mimic IE, now changed in RFC</span>
                        <span class="c1"># https://github.com/kennethreitz/requests/pull/269</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">303</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_HEAD</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_POST</span>
                        <span class="p">):</span>
                            <span class="n">method</span> <span class="o">=</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_GET</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">CONTENT_LENGTH</span><span class="p">):</span>
                                <span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">CONTENT_LENGTH</span><span class="p">)</span>

                        <span class="n">r_url</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">)</span> <span class="ow">or</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">hdrs</span><span class="o">.</span><span class="n">URI</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">r_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># see github.com/aio-libs/aiohttp/issues/2022</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># reading from correct redirection</span>
                            <span class="c1"># response is forbidden</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">URL</span><span class="p">(</span>
                                <span class="n">r_url</span><span class="p">,</span> <span class="n">encoded</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requote_redirect_url</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">InvalidURL</span><span class="p">(</span><span class="n">r_url</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

                        <span class="n">scheme</span> <span class="o">=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span>
                        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Can redirect only to http or https&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">scheme</span><span class="p">:</span>
                            <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parsed_url</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">origin</span><span class="p">()</span> <span class="o">!=</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">origin</span><span class="p">():</span>
                            <span class="n">auth</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">AUTHORIZATION</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                        <span class="n">url</span> <span class="o">=</span> <span class="n">parsed_url</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">resp</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="k">continue</span>

                    <span class="k">break</span>

            <span class="c1"># check response status</span>
            <span class="k">if</span> <span class="n">raise_for_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raise_for_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_for_status</span>
            <span class="k">if</span> <span class="n">raise_for_status</span><span class="p">:</span>
                <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>

            <span class="c1"># register connection</span>
            <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

            <span class="n">resp</span><span class="o">.</span><span class="n">_history</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>


            <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">trace</span><span class="o">.</span><span class="n">send_request_end</span><span class="p">(</span>
                    <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">update_query</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">resp</span>
                <span class="p">)</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">request_meta</span> <span class="o">=</span> <span class="n">request_meta</span>
            <span class="k">return</span> <span class="n">resp</span>

        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># cleanup timer</span>
            <span class="n">tm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">handle</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">traces</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">trace</span><span class="o">.</span><span class="n">send_request_exception</span><span class="p">(</span>
                    <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">update_query</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="p">,</span> <span class="n">e</span>
                <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">ws_connect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_GET</span><span class="p">,</span>
        <span class="n">protocols</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">receive_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">autoclose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">autoping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">heartbeat</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StrOrURL</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Fingerprint</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_ssl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fingerprint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_msg_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_WSRequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initiate websocket connection.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_WSRequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ws_connect</span><span class="p">(</span>
                <span class="n">url</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">protocols</span><span class="o">=</span><span class="n">protocols</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                <span class="n">receive_timeout</span><span class="o">=</span><span class="n">receive_timeout</span><span class="p">,</span>
                <span class="n">autoclose</span><span class="o">=</span><span class="n">autoclose</span><span class="p">,</span>
                <span class="n">autoping</span><span class="o">=</span><span class="n">autoping</span><span class="p">,</span>
                <span class="n">heartbeat</span><span class="o">=</span><span class="n">heartbeat</span><span class="p">,</span>
                <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
                <span class="n">proxy_auth</span><span class="o">=</span><span class="n">proxy_auth</span><span class="p">,</span>
                <span class="n">ssl</span><span class="o">=</span><span class="n">ssl</span><span class="p">,</span>
                <span class="n">verify_ssl</span><span class="o">=</span><span class="n">verify_ssl</span><span class="p">,</span>
                <span class="n">fingerprint</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">,</span>
                <span class="n">ssl_context</span><span class="o">=</span><span class="n">ssl_context</span><span class="p">,</span>
                <span class="n">proxy_headers</span><span class="o">=</span><span class="n">proxy_headers</span><span class="p">,</span>
                <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
                <span class="n">max_msg_size</span><span class="o">=</span><span class="n">max_msg_size</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_ws_connect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_GET</span><span class="p">,</span>
        <span class="n">protocols</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
        <span class="n">receive_timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">autoclose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">autoping</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">heartbeat</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StrOrURL</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Fingerprint</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify_ssl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fingerprint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ssl_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSLContext</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">compress</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">max_msg_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientWebSocketResponse</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">real_headers</span><span class="p">:</span> <span class="n">CIMultiDict</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">CIMultiDict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_headers</span> <span class="o">=</span> <span class="n">CIMultiDict</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

        <span class="n">default_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">UPGRADE</span><span class="p">:</span> <span class="s2">&quot;websocket&quot;</span><span class="p">,</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">CONNECTION</span><span class="p">:</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_VERSION</span><span class="p">:</span> <span class="s2">&quot;13&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">default_headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">real_headers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">sec_key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
        <span class="n">real_headers</span><span class="p">[</span><span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="n">sec_key</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">protocols</span><span class="p">:</span>
            <span class="n">real_headers</span><span class="p">[</span><span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_PROTOCOL</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">real_headers</span><span class="p">[</span><span class="n">hdrs</span><span class="o">.</span><span class="n">ORIGIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
            <span class="n">extstr</span> <span class="o">=</span> <span class="n">ws_ext_gen</span><span class="p">(</span><span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">)</span>
            <span class="n">real_headers</span><span class="p">[</span><span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_EXTENSIONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">extstr</span>

        <span class="n">ssl</span> <span class="o">=</span> <span class="n">_merge_ssl_params</span><span class="p">(</span><span class="n">ssl</span><span class="p">,</span> <span class="n">verify_ssl</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">,</span> <span class="n">fingerprint</span><span class="p">)</span>

        <span class="c1"># send request</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span>
            <span class="n">url</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">real_headers</span><span class="p">,</span>
            <span class="n">read_until_eof</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">,</span>
            <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">proxy_auth</span><span class="o">=</span><span class="n">proxy_auth</span><span class="p">,</span>
            <span class="n">ssl</span><span class="o">=</span><span class="n">ssl</span><span class="p">,</span>
            <span class="n">proxy_headers</span><span class="o">=</span><span class="n">proxy_headers</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check handshake</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">101</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WSServerHandshakeError</span><span class="p">(</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">request_info</span><span class="p">,</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid response status&quot;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">UPGRADE</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;websocket&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WSServerHandshakeError</span><span class="p">(</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">request_info</span><span class="p">,</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid upgrade header&quot;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">CONNECTION</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;upgrade&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WSServerHandshakeError</span><span class="p">(</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">request_info</span><span class="p">,</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid connection header&quot;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># key calculation</span>
            <span class="n">r_key</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_ACCEPT</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">sec_key</span> <span class="o">+</span> <span class="n">WS_KEY</span><span class="p">)</span><span class="o">.</span><span class="n">digest</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r_key</span> <span class="o">!=</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">WSServerHandshakeError</span><span class="p">(</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">request_info</span><span class="p">,</span>
                    <span class="n">resp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Invalid challenge response&quot;</span><span class="p">,</span>
                    <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># websocket protocol</span>
            <span class="n">protocol</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">protocols</span> <span class="ow">and</span> <span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_PROTOCOL</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
                <span class="n">resp_protocols</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">proto</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_PROTOCOL</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="p">]</span>

                <span class="k">for</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">resp_protocols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">proto</span> <span class="ow">in</span> <span class="n">protocols</span><span class="p">:</span>
                        <span class="n">protocol</span> <span class="o">=</span> <span class="n">proto</span>
                        <span class="k">break</span>

            <span class="c1"># websocket compress</span>
            <span class="n">notakeover</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">compress</span><span class="p">:</span>
                <span class="n">compress_hdrs</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">SEC_WEBSOCKET_EXTENSIONS</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">compress_hdrs</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">compress</span><span class="p">,</span> <span class="n">notakeover</span> <span class="o">=</span> <span class="n">ws_ext_parse</span><span class="p">(</span><span class="n">compress_hdrs</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">WSHandshakeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">WSServerHandshakeError</span><span class="p">(</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">request_info</span><span class="p">,</span>
                            <span class="n">resp</span><span class="o">.</span><span class="n">history</span><span class="p">,</span>
                            <span class="n">message</span><span class="o">=</span><span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                            <span class="n">headers</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                        <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">compress</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">notakeover</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">connection</span>
            <span class="k">assert</span> <span class="n">conn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">conn_proto</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">protocol</span>
            <span class="k">assert</span> <span class="n">conn_proto</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">transport</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">transport</span>
            <span class="k">assert</span> <span class="n">transport</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">reader</span><span class="p">:</span> <span class="n">FlowControlDataQueue</span><span class="p">[</span><span class="n">WSMessage</span><span class="p">]</span> <span class="o">=</span> <span class="n">FlowControlDataQueue</span><span class="p">(</span>
                <span class="n">conn_proto</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop</span>
            <span class="p">)</span>
            <span class="n">conn_proto</span><span class="o">.</span><span class="n">set_parser</span><span class="p">(</span><span class="n">WebSocketReader</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">max_msg_size</span><span class="p">),</span> <span class="n">reader</span><span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">WebSocketWriter</span><span class="p">(</span>
                <span class="n">conn_proto</span><span class="p">,</span>
                <span class="n">transport</span><span class="p">,</span>
                <span class="n">use_mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
                <span class="n">notakeover</span><span class="o">=</span><span class="n">notakeover</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">resp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ws_response_class</span><span class="p">(</span>
                <span class="n">reader</span><span class="p">,</span>
                <span class="n">writer</span><span class="p">,</span>
                <span class="n">protocol</span><span class="p">,</span>
                <span class="n">resp</span><span class="p">,</span>
                <span class="n">timeout</span><span class="p">,</span>
                <span class="n">autoclose</span><span class="p">,</span>
                <span class="n">autoping</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">,</span>
                <span class="n">receive_timeout</span><span class="o">=</span><span class="n">receive_timeout</span><span class="p">,</span>
                <span class="n">heartbeat</span><span class="o">=</span><span class="n">heartbeat</span><span class="p">,</span>
                <span class="n">compress</span><span class="o">=</span><span class="n">compress</span><span class="p">,</span>
                <span class="n">client_notakeover</span><span class="o">=</span><span class="n">notakeover</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prepare_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LooseHeaders</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;CIMultiDict[str]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add default headers and transform it to CIMultiDict&quot;&quot;&quot;</span>
        <span class="c1"># Convert headers to MultiDict</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">CIMultiDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="p">(</span><span class="n">MultiDictProxy</span><span class="p">,</span> <span class="n">MultiDict</span><span class="p">)):</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="n">CIMultiDict</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">added_names</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">added_names</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">added_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP GET request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_GET</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">options</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP OPTIONS request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span>
                <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_OPTIONS</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP HEAD request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span>
                <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_HEAD</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP POST request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_POST</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP PUT request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_PUT</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">patch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP PATCH request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_PATCH</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform HTTP DELETE request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_DELETE</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close underlying connector.</span>

<span class="sd">        Release all acquired resources.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector_owner</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Is client session closed.</span>

<span class="sd">        A readonly property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span><span class="o">.</span><span class="n">closed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BaseConnector</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connector instance used for the session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cookie_jar</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractCookieJar</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The session cookies.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookie_jar</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The session HTTP protocol version.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">requote_redirect_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do URL requoting on redirection handling.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_requote_redirect_url</span>

    <span class="nd">@requote_redirect_url</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">requote_redirect_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do URL requoting on redirection handling.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;session.requote_redirect_url modification &quot;</span> <span class="s2">&quot;is deprecated #2778&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_requote_redirect_url</span> <span class="o">=</span> <span class="n">val</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Session&#39;s loop.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;client.loop property is deprecated&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientTimeout</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Timeout for the session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;CIMultiDict[str]&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The default headers of the client session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_headers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">skip_auto_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">istr</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Headers for which autogeneration should be skipped&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skip_auto_headers</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BasicAuth</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An object that represents HTTP Basic Authorization&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_auth</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">json_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">JSONEncoder</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Json serializer callable&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_serialize</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connector_owner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Should connector be closed on session closing&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector_owner</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">raise_for_status</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ClientResponse</span><span class="p">],</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Should `ClientResponse.raise_for_status()` be called for each response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raise_for_status</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">auto_decompress</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Should the body response be automatically decompressed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto_decompress</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trust_env</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Should proxies information from environment or netrc be trusted.</span>

<span class="sd">        Information is from HTTP_PROXY / HTTPS_PROXY environment variables</span>
<span class="sd">        or ~/.netrc file if present.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trust_env</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">trace_configs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TraceConfig</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A list of TraceConfig instances used for client tracing&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trace_configs</span>

    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detach connector from session without closing the former.</span>

<span class="sd">        Session is switched to closed state anyway.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Use async with instead&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">exc_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># __exit__ should exist in pair with __enter__ but never executed</span>
        <span class="k">pass</span>  <span class="c1"># pragma: no cover</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ClientSession&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">exc_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">exc_tb</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.client.ClientSession.closed" class="doc doc-heading">
<code class="highlight language-python"><span class="n">closed</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Is client session closed.</p>
<p>A readonly property.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.client.ClientSession.connector" class="doc doc-heading">
<code class="highlight language-python"><span class="n">connector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">aiohttp</span><span class="o">.</span><span class="n">connector</span><span class="o">.</span><span class="n">BaseConnector</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Connector instance used for the session.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.client.ClientSession.cookie_jar" class="doc doc-heading">
<code class="highlight language-python"><span class="n">cookie_jar</span><span class="p">:</span> <span class="n">AbstractCookieJar</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>The session cookies.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.client.ClientSession.headers" class="doc doc-heading">
<code class="highlight language-python"><span class="n">headers</span><span class="p">:</span> <span class="n">CIMultiDict</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>The default headers of the client session.</p>
    </div>

  </div>



  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.client.ClientSession.timeout" class="doc doc-heading">
<code class="highlight language-python"><span class="n">timeout</span><span class="p">:</span> <span class="n">ClientTimeout</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Timeout for the session.</p>
    </div>

  </div>






  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.close" class="doc doc-heading">
<code class="highlight language-python"><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Close underlying connector.</p>
<p>Release all acquired resources.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Close underlying connector.</span>

<span class="sd">    Release all acquired resources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector_owner</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.delete" class="doc doc-heading">
<code class="highlight language-python"><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP DELETE request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP DELETE request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_DELETE</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.detach" class="doc doc-heading">
<code class="highlight language-python"><span class="n">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Detach connector from session without closing the former.</p>
<p>Session is switched to closed state anyway.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detach connector from session without closing the former.</span>

<span class="sd">    Session is switched to closed state anyway.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_connector</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.get" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP GET request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP GET request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_GET</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.head" class="doc doc-heading">
<code class="highlight language-python"><span class="n">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP HEAD request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">head</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP HEAD request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_HEAD</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.options" class="doc doc-heading">
<code class="highlight language-python"><span class="n">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP OPTIONS request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">options</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP OPTIONS request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span>
            <span class="n">hdrs</span><span class="o">.</span><span class="n">METH_OPTIONS</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="n">allow_redirects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.patch" class="doc doc-heading">
<code class="highlight language-python"><span class="n">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP PATCH request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">patch</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP PATCH request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_PATCH</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.post" class="doc doc-heading">
<code class="highlight language-python"><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP POST request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">post</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP POST request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_POST</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.put" class="doc doc-heading">
<code class="highlight language-python"><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP PUT request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">put</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP PUT request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">hdrs</span><span class="o">.</span><span class="n">METH_PUT</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.client.ClientSession.request" class="doc doc-heading">
<code class="highlight language-python"><span class="n">request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Perform HTTP request.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\client.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="n">StrOrURL</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;_RequestContextManager&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform HTTP request.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContextManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h3 id="loadusershape-class"><br /><span id="LoadUserShape">LoadUserShape class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.shape.LoadUserShape"></a>
    <div class="doc doc-contents first">

      <p>A simple load test shape class used to control the shape of load generated
during a load test.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\shape.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LoadUserShape</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple load test shape class used to control the shape of load generated</span>
<span class="sd">    during a load test.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">default_timer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Resets start time back to 0&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">default_timer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_run_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Calculates run time in seconds of the load user&quot;</span>
        <span class="k">return</span> <span class="n">default_timer</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple with 2 elements to control the running load user:</span>
<span class="sd">            user_count -- Total user count</span>
<span class="sd">            rate -- Number of users to start/stop per second when changing number of users</span>
<span class="sd">        if &#39;None&#39; is returned then the running load user will be stopped.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h2 id="aiotest.shape.LoadUserShape.get_run_time" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_run_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Calculates run time in seconds of the load user</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\shape.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_run_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Calculates run time in seconds of the load user&quot;</span>
    <span class="k">return</span> <span class="n">default_timer</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.shape.LoadUserShape.reset_time" class="doc doc-heading">
<code class="highlight language-python"><span class="n">reset_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Resets start time back to 0</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\shape.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">reset_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Resets start time back to 0&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">default_timer</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.shape.LoadUserShape.tick" class="doc doc-heading">
<code class="highlight language-python"><span class="n">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Returns a tuple with 2 elements to control the running load user:
    user_count -- Total user count
    rate -- Number of users to start/stop per second when changing number of users
if 'None' is returned then the running load user will be stopped.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\shape.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a tuple with 2 elements to control the running load user:</span>
<span class="sd">        user_count -- Total user count</span>
<span class="sd">        rate -- Number of users to start/stop per second when changing number of users</span>
<span class="sd">    if &#39;None&#39; is returned then the running load user will be stopped.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h3 id="runner-class"><br /><span id="Runner">Runner class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.runners.Runner"></a>
    <div class="doc doc-contents first">


        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Runner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_classes</span><span class="p">,</span> <span class="n">shape_class</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span> <span class="o">=</span> <span class="n">user_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_class</span> <span class="o">=</span> <span class="n">shape_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpu_usage</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_INIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Returns the number of running user tasks, a user equals a task&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">instances</span> <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_state</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating state to </span><span class="si">{</span><span class="n">new_state</span><span class="si">}</span><span class="s2">, old state was </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_state</span>

    <span class="k">def</span> <span class="nf">weight_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Distributes the amount of users for each User-class according to it&#39;s weight returns a list &quot;bucket&quot; with the weighted users</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weight_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span><span class="p">:</span>
                <span class="n">user</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">weight</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">weight_sum</span> <span class="o">+=</span> <span class="n">user</span><span class="o">.</span><span class="n">weight</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;weigth value must be an int type and &gt;= 1&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Userclass must have weight attribute&quot;</span><span class="p">)</span>

        <span class="n">residuals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span><span class="p">:</span>
            <span class="c1"># create users depending on weight</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">weight_sum</span>
            <span class="n">num_users</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="n">percent</span><span class="p">)</span>
            <span class="n">residuals</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">-</span> <span class="n">num_users</span>

            <span class="n">bucket</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">user</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span><span class="p">)])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)][:</span><span class="n">amount</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)]:</span>
                <span class="n">bucket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">amount</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][:</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">-</span><span class="n">amount</span><span class="p">]:</span>
                <span class="n">bucket</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="c1"># [&lt;class &#39;User01&#39;&gt;, &lt;class &#39;User02&#39;&gt;,...]    </span>
        <span class="k">return</span> <span class="n">bucket</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="s2">&quot;Create user tasks for a load test master entry&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">user_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> mast be int type and &gt;= 1&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="n">user_count</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> mast &gt; 0 and &lt; user_count </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">rate</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> rate fractional part is&#39;t 0&quot;</span><span class="p">)</span> 

        <span class="c1"># Dynamically changing the user count</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">STATE_STARTING</span><span class="p">,</span> <span class="n">STATE_RUNNING</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating running test with </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users, </span><span class="si">{</span><span class="n">rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> rate.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">&gt;</span> <span class="n">user_count</span><span class="p">:</span>
                <span class="c1"># stop some users</span>
                <span class="n">stop_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">-</span> <span class="n">user_count</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_users</span><span class="p">(</span><span class="n">stop_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">&lt;</span> <span class="n">user_count</span><span class="p">:</span>
                <span class="c1"># start some users</span>
                <span class="n">start_count</span> <span class="o">=</span> <span class="n">user_count</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_users</span><span class="p">(</span><span class="n">start_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_users</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">start_complete</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">user_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runner state is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>  
        <span class="s2">&quot;Create a specified number of user tasks, a user equals a task&quot;</span>         
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_users</span><span class="p">(</span><span class="n">user_count</span><span class="p">)</span> <span class="c1"># [&lt;class &#39;User01&#39;&gt;, &lt;class &#39;User02&#39;&gt;,...]  </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>

        <span class="n">existing_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="si">}</span><span class="s2"> users at the rate </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> users/s, (</span><span class="si">{</span><span class="n">existing_count</span><span class="si">}</span><span class="s2"> users already running)...&quot;</span><span class="p">)</span>
        <span class="n">start_count</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span><span class="p">)</span> <span class="c1"># {&#39;User01&#39;: 0, &#39;User02&#39;: 0...}</span>

        <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)):</span>
            <span class="n">user_class</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">start_count</span><span class="p">[</span><span class="n">user_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">new_user</span> <span class="o">=</span> <span class="n">user_class</span><span class="p">()</span>
            <span class="n">new_user</span><span class="o">.</span><span class="n">start_user</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users started&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All users started: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">start_count</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">  have user_class don&#39;t started&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>  
        <span class="s2">&quot;Cancels a specified number of user tasks&quot;</span>
        <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_users</span><span class="p">(</span><span class="n">user_count</span><span class="p">)</span> <span class="c1"># [&lt;class &#39;User01&#39;&gt;, &lt;class &#39;User02&#39;&gt;,...]  </span>
        <span class="n">user_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
        <span class="n">stop_users</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">user_class</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">user_class</span><span class="p">):</span>
                        <span class="n">stop_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
                        <span class="n">bucket</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user_class</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">user_count</span><span class="p">:</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users immediately&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stoping </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users at rate of </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> users/s&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="n">stop_users</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">instances</span><span class="o">.</span><span class="n">stop_user</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">instances</span> <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
        <span class="n">stop_users</span> <span class="o">=</span> <span class="p">[</span><span class="n">instances</span> <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="n">stop_users</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">stop_users</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are still user tasks uncancelled: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stop_users</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Cancel all user tasks&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping all users&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;all user task is done: </span><span class="si">{</span><span class="nb">all</span><span class="p">([</span><span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;users_tasks&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STOPPED</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Exit the load test and cancel all runner tasks&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">quitting</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="n">task</span> <span class="o">!=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">():</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runner&#39;s tasks is done: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Create a load test policy task&quot;</span>
        <span class="n">shape_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_run</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shape_task&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape_task</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">shape_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Execute the specified load test policy&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shape starting&quot;</span><span class="p">)</span>
        <span class="n">shape_last</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">shape_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_class</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">shape_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shape test stopping&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="n">shape_last</span> <span class="o">==</span> <span class="n">shape_new</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">shape_new</span><span class="p">)</span>
                <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">shape_new</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape test updating to </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users at </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> rate&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">user_count</span><span class="o">=</span><span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span>
                <span class="n">shape_last</span> <span class="o">=</span> <span class="n">shape_new</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.runners.Runner.user_count" class="doc doc-heading">
<code class="highlight language-python"><span class="n">user_count</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Returns the number of running user tasks, a user equals a task</p>
    </div>

  </div>








  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.quit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Exit the load test and cancel all runner tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Exit the load test and cancel all runner tasks&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">quitting</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()</span> <span class="ow">and</span> <span class="n">task</span> <span class="o">!=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runner&#39;s tasks is done: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.shape_run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">shape_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Execute the specified load test policy</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">shape_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Execute the specified load test policy&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shape starting&quot;</span><span class="p">)</span>
    <span class="n">shape_last</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">shape_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_class</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">shape_new</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Shape test stopping&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">shape_last</span> <span class="o">==</span> <span class="n">shape_new</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">shape_new</span><span class="p">)</span>
            <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">shape_new</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape test updating to </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users at </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> rate&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">user_count</span><span class="o">=</span><span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span>
            <span class="n">shape_last</span> <span class="o">=</span> <span class="n">shape_new</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Create user tasks for a load test master entry</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
    <span class="s2">&quot;Create user tasks for a load test master entry&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">user_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> mast be int type and &gt;= 1&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="n">user_count</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> mast &gt; 0 and &lt; user_count </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> 
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">rate</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> rate fractional part is&#39;t 0&quot;</span><span class="p">)</span> 

    <span class="c1"># Dynamically changing the user count</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">STATE_STARTING</span><span class="p">,</span> <span class="n">STATE_RUNNING</span><span class="p">]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updating running test with </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users, </span><span class="si">{</span><span class="n">rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> rate.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">&gt;</span> <span class="n">user_count</span><span class="p">:</span>
            <span class="c1"># stop some users</span>
            <span class="n">stop_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">-</span> <span class="n">user_count</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_users</span><span class="p">(</span><span class="n">stop_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">&lt;</span> <span class="n">user_count</span><span class="p">:</span>
            <span class="c1"># start some users</span>
            <span class="n">start_count</span> <span class="o">=</span> <span class="n">user_count</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_users</span><span class="p">(</span><span class="n">start_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_users</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">start_complete</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">user_count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runner state is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.start_shape" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Create a load test policy task</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">start_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Create a load test policy task&quot;</span>
    <span class="n">shape_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_run</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;shape_task&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape_task</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.start_users" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Create a specified number of user tasks, a user equals a task</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>  
    <span class="s2">&quot;Create a specified number of user tasks, a user equals a task&quot;</span>         
    <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_users</span><span class="p">(</span><span class="n">user_count</span><span class="p">)</span> <span class="c1"># [&lt;class &#39;User01&#39;&gt;, &lt;class &#39;User02&#39;&gt;,...]  </span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>

    <span class="n">existing_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="si">}</span><span class="s2"> users at the rate </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> users/s, (</span><span class="si">{</span><span class="n">existing_count</span><span class="si">}</span><span class="s2"> users already running)...&quot;</span><span class="p">)</span>
    <span class="n">start_count</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">u</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span><span class="p">)</span> <span class="c1"># {&#39;User01&#39;: 0, &#39;User02&#39;: 0...}</span>

    <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)):</span>
        <span class="n">user_class</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">start_count</span><span class="p">[</span><span class="n">user_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">new_user</span> <span class="o">=</span> <span class="n">user_class</span><span class="p">()</span>
        <span class="n">new_user</span><span class="o">.</span><span class="n">start_user</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users started&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">bucket</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All users started: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">start_count</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bucket</span><span class="si">}</span><span class="s2">  have user_class don&#39;t started&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Cancel all user tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Cancel all user tasks&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping all users&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_users</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;all user task is done: </span><span class="si">{</span><span class="nb">all</span><span class="p">([</span><span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">instances</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;users_tasks&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STOPPED</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.stop_users" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Cancels a specified number of user tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">stop_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>  
    <span class="s2">&quot;Cancels a specified number of user tasks&quot;</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_users</span><span class="p">(</span><span class="n">user_count</span><span class="p">)</span> <span class="c1"># [&lt;class &#39;User01&#39;&gt;, &lt;class &#39;User02&#39;&gt;,...]  </span>
    <span class="n">user_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span>
    <span class="n">stop_users</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">user_class</span> <span class="ow">in</span> <span class="n">bucket</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instances</span><span class="p">,</span> <span class="n">user_class</span><span class="p">):</span>
                    <span class="n">stop_users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
                    <span class="n">bucket</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user_class</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">user_count</span><span class="p">:</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users immediately&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rate</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stoping </span><span class="si">{</span><span class="n">user_count</span><span class="si">}</span><span class="s2"> users at rate of </span><span class="si">{</span><span class="n">rate</span><span class="si">}</span><span class="s2"> users/s&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="n">stop_users</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">instances</span><span class="o">.</span><span class="n">stop_user</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span> <span class="o">=</span> <span class="p">[</span><span class="n">instances</span> <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_instances</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
    <span class="n">stop_users</span> <span class="o">=</span> <span class="p">[</span><span class="n">instances</span> <span class="k">for</span> <span class="n">instances</span> <span class="ow">in</span> <span class="n">stop_users</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">instances</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">stop_users</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are still user tasks uncancelled: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stop_users</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.Runner.weight_users" class="doc doc-heading">
<code class="highlight language-python"><span class="n">weight_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">)</span></code>


</h2>

    <div class="doc doc-contents ">

      <p>Distributes the amount of users for each User-class according to it's weight returns a list "bucket" with the weighted users</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">weight_users</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Distributes the amount of users for each User-class according to it&#39;s weight returns a list &quot;bucket&quot; with the weighted users</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weight_sum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">weight</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">weight_sum</span> <span class="o">+=</span> <span class="n">user</span><span class="o">.</span><span class="n">weight</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;weigth value must be an int type and &gt;= 1&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;Userclass must have weight attribute&quot;</span><span class="p">)</span>

    <span class="n">residuals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_classes</span><span class="p">:</span>
        <span class="c1"># create users depending on weight</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">weight_sum</span>
        <span class="n">num_users</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="n">percent</span><span class="p">)</span>
        <span class="n">residuals</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">-</span> <span class="n">num_users</span>

        <span class="n">bucket</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">user</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_users</span><span class="p">)])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)][:</span><span class="n">amount</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)]:</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">amount</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">residuals</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])][:</span><span class="nb">len</span><span class="p">(</span><span class="n">bucket</span><span class="p">)</span><span class="o">-</span><span class="n">amount</span><span class="p">]:</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># [&lt;class &#39;User01&#39;&gt;, &lt;class &#39;User02&#39;&gt;,...]    </span>
    <span class="k">return</span> <span class="n">bucket</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h3 id="localrunner-class"><br /><span id="LocalRunner">LocalRunner class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.runners.LocalRunner"></a>
    <div class="doc doc-contents first">


        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LocalRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_classes</span><span class="p">,</span> <span class="n">shape_class</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">user_classes</span><span class="p">,</span> <span class="n">shape_class</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">user_count_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">exporter_user_count</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;user_count_task&quot;</span><span class="p">)</span>
        <span class="n">prometheus_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">prometheus_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">prometheus_port</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;prometheus&quot;</span><span class="p">)</span>
        <span class="n">monitor_cpu_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">exporter_cpu_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;monitor_cpu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user_count_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prometheus_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor_cpu_task</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your selected rate is very high (&gt;100), and this is known to sometimes cause issues. Do you really need to ramp up that fast?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_start</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;users_tasks&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="c1"># cancel existing task(name=&#39;users_tasks&#39;) before we start a new one</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="n">users_tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;users_tasks&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">users_tasks</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if self.state == STATE_STOPPED:</span>
        <span class="c1">#     return</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_stop</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.LocalRunner.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Create user tasks for a load test master entry</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your selected rate is very high (&gt;100), and this is known to sometimes cause issues. Do you really need to ramp up that fast?&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_start</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;users_tasks&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
            <span class="c1"># cancel existing task(name=&#39;users_tasks&#39;) before we start a new one</span>
            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">break</span>
    <span class="n">users_tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;users_tasks&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">users_tasks</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.LocalRunner.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Cancel all user tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># if self.state == STATE_STOPPED:</span>
    <span class="c1">#     return</span>
    <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_stop</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>

<h3 id="masterrunner-class"><br /><span id="MasterRunner">MasterRunner class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.runners.MasterRunner"></a>
    <div class="doc doc-contents first">

      <p>Runner used to run distributed load tests across multiple processes and/or machines.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MasterRunner</span><span class="p">(</span><span class="n">DistributedRunner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runner used to run distributed load tests across multiple processes and/or machines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">WorkerNodesDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">get_by_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">]</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_state</span><span class="p">(</span><span class="n">STATE_INIT</span><span class="p">)</span>
            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">starting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">running</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>

            <span class="nd">@property</span>
            <span class="k">def</span> <span class="nf">missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_state</span><span class="p">(</span><span class="n">STATE_MISSING</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">WorkerNodesDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_bind_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bind_port</span><span class="p">)</span>

        <span class="n">worekr_heartbeat_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_heartbeat</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;worekr_heartbeat&quot;</span><span class="p">)</span>
        <span class="n">worekr_listener_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worekr_listener</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;worekr_listener&quot;</span><span class="p">)</span>
        <span class="n">prometheus_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">prometheus_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">prometheus_port</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;prometheus&quot;</span><span class="p">)</span>
        <span class="n">monitor_cpu_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">exporter_cpu_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;monitor_cpu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worekr_heartbeat_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worekr_listener_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prometheus_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor_cpu_task</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">user_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">user_count</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">worker_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">ready</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">starting</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        <span class="n">num_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_count</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">num_workers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You are running in distributed mode but have no worker servers connected. Please connect workers prior to swarming.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">worker_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span>
        <span class="n">worker_user_count</span> <span class="o">=</span> <span class="n">user_count</span> <span class="o">//</span> <span class="p">(</span><span class="n">num_workers</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 每个worker分配user_count</span>
        <span class="n">worker_rate</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_workers</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 每个worker生成user速率</span>
        <span class="n">remainig</span> <span class="o">=</span> <span class="n">user_count</span> <span class="o">%</span> <span class="n">num_workers</span> <span class="c1"># 剩下的user_count</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending jobs of </span><span class="si">{</span><span class="n">worker_user_count</span><span class="si">}</span><span class="s2"> users and </span><span class="si">{</span><span class="n">worker_rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> rate to </span><span class="si">{</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> ready workers&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">worker_rate</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your selected rate is very high (&gt;100/worker), and this is known to sometimes cause issues. Do you really need to ramp up that fast?&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_start</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">ready</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">starting</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">running</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;user_count&quot;</span><span class="p">:</span> <span class="n">worker_user_count</span><span class="p">,</span>
                <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="n">worker_rate</span><span class="p">,</span>
                <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">worker_host</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">remainig</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">remainig</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending start users message to worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_to_worker</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping...&quot;</span><span class="p">)</span>  
        <span class="c1"># 避免直到tick（）发出另一个变化信号时才停止</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_class</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tactics_current</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending stop message to worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_to_worker</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_stop</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STOPPED</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Quitting...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending quit message to worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_to_worker</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;quit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># wait for final stats report from all workers</span>
            <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">quitting</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">worker_heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">HEARTBEAT_INTERVAL</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_broken</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_connection</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">heartbeat</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_MISSING</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> failed to send heartbeat, setting state to missing.&quot;</span><span class="p">)</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_MISSING</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">user_count</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_count</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">missing</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The last worker went missing, stopping test.&quot;</span><span class="p">)</span>
                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">worker</span><span class="o">.</span><span class="n">heartbeat</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reset connection to worker&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_bind_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_bind_port</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RPCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary failure when resetting connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, will retry later.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">worekr_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">worker_id</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">recv_from_worker</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">node_id</span> <span class="o">=</span> <span class="n">worker_id</span>            
            <span class="k">except</span> <span class="n">RPCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RPCError found when receiving from worker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection_broken</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">FALLBACK_INTERVAL</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_broken</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;heartbeat&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">worker_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">heartbeat</span> <span class="o">=</span> <span class="n">HEARTBEAT_LIVENESS</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">cpu_usage</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;cpu_usage&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">cpu_usage</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2"> exceeded CPU threshold&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;stats&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">worker_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discarded report from unrecognized worker </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span><span class="o">.</span><span class="n">user_count</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_count&quot;</span><span class="p">]</span>
                <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">worker_report</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_id</span><span class="o">=</span><span class="n">worker_id</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">user_error</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">])</span>   
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;ready&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">WorkerNode</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">worker_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2"> reported as ready. Currently </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_count</span><span class="si">}</span><span class="s2"> workers ready to swarm.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="n">STATE_STARTING</span><span class="p">,</span> <span class="n">STATE_RUNNING</span><span class="p">]:</span>
                    <span class="c1"># balance the load distribution when new worker joins</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">rate</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;starting&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_STARTING</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;start_complete&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_RUNNING</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span><span class="o">.</span><span class="n">user_count</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_count&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">running</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">all</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_RUNNING</span><span class="p">)</span>
                    <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">start_complete</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">user_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_count</span><span class="p">,</span> <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;stopped&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">worker_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2"> worker from running workers&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;quitted&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">worker_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">worker_id</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Worker </span><span class="si">{</span><span class="n">worker_id</span><span class="si">}</span><span class="s2"> quitted. Currently </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_count</span><span class="si">}</span><span class="s2"> workers connected.&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">






  <div class="doc doc-object doc-attribute">



<h2 id="aiotest.runners.MasterRunner.user_count" class="doc doc-heading">
<code class="highlight language-python"><span class="n">user_count</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-property"><code>property</code></small>
      <small class="doc doc-property doc-property-readonly"><code>readonly</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Returns the number of running user tasks, a user equals a task</p>
    </div>

  </div>








  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.MasterRunner.quit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Exit the load test and cancel all runner tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Quitting...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_quit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending quit message to worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_to_worker</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;quit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># wait for final stats report from all workers</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">quitting</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.MasterRunner.start" class="doc doc-heading">
<code class="highlight language-python"><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Create user tasks for a load test master entry</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_count</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">num_workers</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You are running in distributed mode but have no worker servers connected. Please connect workers prior to swarming.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">worker_host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span>
    <span class="n">worker_user_count</span> <span class="o">=</span> <span class="n">user_count</span> <span class="o">//</span> <span class="p">(</span><span class="n">num_workers</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 每个worker分配user_count</span>
    <span class="n">worker_rate</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="n">num_workers</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 每个worker生成user速率</span>
    <span class="n">remainig</span> <span class="o">=</span> <span class="n">user_count</span> <span class="o">%</span> <span class="n">num_workers</span> <span class="c1"># 剩下的user_count</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending jobs of </span><span class="si">{</span><span class="n">worker_user_count</span><span class="si">}</span><span class="s2"> users and </span><span class="si">{</span><span class="n">worker_rate</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> rate to </span><span class="si">{</span><span class="n">num_workers</span><span class="si">}</span><span class="s2"> ready workers&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">worker_rate</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Your selected rate is very high (&gt;100/worker), and this is known to sometimes cause issues. Do you really need to ramp up that fast?&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_start</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STARTING</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">ready</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">starting</span> <span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">running</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;user_count&quot;</span><span class="p">:</span> <span class="n">worker_user_count</span><span class="p">,</span>
            <span class="s2">&quot;rate&quot;</span><span class="p">:</span> <span class="n">worker_rate</span><span class="p">,</span>
            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">worker_host</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">remainig</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">remainig</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending start users message to worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_to_worker</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.MasterRunner.stop" class="doc doc-heading">
<code class="highlight language-python"><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Cancel all user tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping...&quot;</span><span class="p">)</span>  
    <span class="c1"># 避免直到tick（）发出另一个变化信号时才停止</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_class</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tactics_current</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">workers</span><span class="o">.</span><span class="n">all</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending stop message to worker </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">send_to_worker</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="k">await</span> <span class="n">events</span><span class="o">.</span><span class="n">test_stop</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">STATE_STOPPED</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>

<h3 id="workerrunner-class"><br /><span id="WorkerRunner">WorkerRunner class</span></h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.runners.WorkerRunner"></a>
    <div class="doc doc-contents first">

      <p>Runner used to run distributed load tests across multiple processes and/or machines.</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WorkerRunner</span><span class="p">(</span><span class="n">DistributedRunner</span><span class="p">):</span>
    <span class="s2">&quot;Runner used to run distributed load tests across multiple processes and/or machines.&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_state</span> <span class="o">=</span> <span class="n">STATE_INIT</span>
        <span class="c1"># 主机ip地址 + 随机码</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>

        <span class="n">heartbeat_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heartbeat</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;heartbeat&quot;</span><span class="p">)</span>
        <span class="n">worker_run_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_run</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;worker_run&quot;</span><span class="p">)</span>
        <span class="n">monitor_cpu_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">exporter_cpu_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;monitor_cpu&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">heartbeat_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker_run_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">monitor_cpu_task</span><span class="p">)</span>

        <span class="n">events</span><span class="o">.</span><span class="n">start_complete</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_start_complete</span>
        <span class="n">events</span><span class="o">.</span><span class="n">quitting</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_quitting</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_start_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">runner</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;start_complete&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;user_count&quot;</span><span class="p">:</span><span class="n">user_count</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_state</span> <span class="o">=</span> <span class="n">STATE_RUNNING</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_quitting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;quitted&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">))</span> 

    <span class="k">async</span> <span class="k">def</span> <span class="nf">heartbeat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span>
                    <span class="n">Message</span><span class="p">(</span>
                        <span class="s2">&quot;heartbeat&quot;</span><span class="p">,</span>
                        <span class="p">{</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_state</span><span class="p">,</span> <span class="s2">&quot;cpu_usage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cpu_usage</span><span class="p">},</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">RPCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RPCError found when sending heartbeat: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_connection</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">HEARTBEAT_INTERVAL</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">reset_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reset connection to master&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">master_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">master_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RPCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Temporary failure when resetting connection: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, will retry later.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">worker_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">))</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>             
            <span class="k">except</span> <span class="n">RPCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RPCError found when receiving from master: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_state</span> <span class="o">=</span> <span class="n">STATE_STARTING</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;starting&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">))</span>
                <span class="n">job</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;host&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;users_tasks&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                        <span class="c1"># cancel existing task(name=&#39;start_user&#39;) before we start a new one</span>
                        <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                        <span class="k">break</span>
                <span class="n">users_tasks</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s2">&quot;user_count&quot;</span><span class="p">],</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;rate&quot;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;users_tasks&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">users_tasks</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;stop&quot;</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;stopped&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_state</span> <span class="o">=</span> <span class="n">STATE_STOPPED</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">worker_state</span> <span class="o">=</span> <span class="n">STATE_INIT</span>
            <span class="k">elif</span> <span class="n">msg</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;quit&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Got quit message from master, shutting down...&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                <span class="k">break</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Exit the load test and cancel all runner tasks&quot;</span>
        <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">













  <div class="doc doc-object doc-method">



<h2 id="aiotest.runners.WorkerRunner.quit" class="doc doc-heading">
<code class="highlight language-python"><span class="n">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>

  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-async"><code>async</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">

      <p>Exit the load test and cancel all runner tasks</p>

        <details class="quote">
          <summary>Source code in <code>aiotest\runners.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;Exit the load test and cancel all runner tasks&quot;</span>
    <span class="k">await</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>







  </div>

    </div>

  </div>

<h3 id="setup_logging"><br />setup_logging</h3>


  <div class="doc doc-object doc-function">

<a id="aiotest.log.setup_logging"></a>
    <div class="doc doc-contents first">


        <details class="quote">
          <summary>Source code in <code>aiotest\log.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">setup_logging</span><span class="p">(</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">loglevel</span> <span class="o">=</span> <span class="n">loglevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">loglevel</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">loglevel</span><span class="p">,</span> <span class="n">retention</span><span class="o">=</span><span class="s2">&quot;1 days&quot;</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>

<h3 id="events-class"><br />Events class</h3>


  <div class="doc doc-object doc-class">

<a id="aiotest.events.EventHook"></a>
    <div class="doc doc-contents first">


        <details class="quote">
          <summary>Source code in <code>aiotest\events.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">EventHook</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__isub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">















  </div>

    </div>

  </div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../testing-other-systems/" class="btn btn-neutral float-left" title="Testing Other Systems"><span class="icon icon-circle-arrow-left"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../testing-other-systems/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>

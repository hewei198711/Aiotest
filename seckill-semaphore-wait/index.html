<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Seckill semaphore wait - Aiotest</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Seckill semaphore wait";
        var mkdocs_page_input_path = "seckill-semaphore-wait.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Aiotest
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../what-is-aiotest/">What is Aiotest</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../quickstart/">Your first test</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../writing-a-aiotestfile/">Writing a aiotestfile</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../command-line-options/">Command Line Options</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-distributed/">Distributed load test</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Seckill semaphore wait</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-in-command-line/">Running In Command Line</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../running-in-docker/">Running in Docker</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../custom-load-shape/">Custom load shapes</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../events-hooks/">Event hooks</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../prometheus-grafana/">Data Presentation</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../testing-other-systems/">Testing Other Systems</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../api/">Api</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Aiotest</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li class="breadcrumb-item active">Seckill semaphore wait</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="seckill-semaphore-wait">Seckill semaphore wait</h2>
<p>In the mall test, there is a seckill scenario, customers have logged in, entered the activity page, and made all the preparations for placing orders, when it is allowed to place orders, all customers place orders at the same time.</p>
<p>We need to have customers log in, wait for everyone to log in, and then place orders at the same time.</p>
<pre><code class="language-python">from aiotest import AsyncHttpUser, LoadUserShape, logger, events
from redis import StrictRedis
from asyncio.locks import Semaphore

db = StrictRedis(
    host=&quot;192.168.0.10&quot;, 
    port=&quot;6379&quot;, 
    db=0, 
    decode_responses=True, 
    password=&quot;123456&quot;
)
pipe = db.pipeline()

all_user_start_complete = Semaphore()
all_user_start_complete.acquire()

async def on_init():
    db.set(&quot;seckill&quot;, 1, ex=3600)


async def on_start_complete(user_count, runner):
    if type(runner).__name__ != &quot;WorkerRunner&quot;:
        db.set(&quot;seckill&quot;, 0, ex=3600)
        all_user_start_complete.release()
        return
    while True:
        if db.get(&quot;seckil&quot;) == 0:
            all_user_start_complete.release()
            return
        await asyncio.sleep(1)

events.init += on_init
events.start_complete += on_start_complete 


class TestUser(AsyncHttpUser):
    host = &quot;https://uat.taobao.com&quot;
    token = None

    async def on_start(self):
        url = &quot;/login&quot;
        data = {&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;123456&quot;}
        async with self.session.post(url=url, data=data) as resp:
            data = await resp.json()
            self.token = data[&quot;token&quot;]
        # Block, wait for all customers to log in
        all_user_start_complete.wait()

    async def test_search(self):
        url = &quot;/search&quot;
        hearders = {&quot;Authorization&quot;: self.token}
        data = {&quot;keyword&quot;: &quot;F22&quot;}
        async with self.session.post(url=url, hearders=hearders, json=data) as resp:
            data = await resp.json()      

    async def test_personal_info(self):
        url = &quot;/personalInfo&quot;
        async with self.session.get(url=url, hearders=hearders) as resp:
            data = await resp.json()

</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../running-distributed/" class="btn btn-neutral float-left" title="Distributed load test"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../running-in-command-line/" class="btn btn-neutral float-right" title="Running In Command Line">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../running-distributed/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../running-in-command-line/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
